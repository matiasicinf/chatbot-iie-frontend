<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat Widget Simple</title>
<style>
  :root {
    --brand: #006D9C;
    --bg: #ffffff;
    --text: #111;
    --muted: #666;
    --bot: #f2f4f7;
    --user: var(--brand);
  }
  body, input, button {
      font-family: 'Poppins', sans-serif;
    }
  /* Bot√≥n flotante */
  #chatbotBtn {
    position: fixed; bottom: 24px; right: 24px; z-index: 2147483646;
    width: 64px; height: 64px; border: 0; border-radius: 16px; cursor: pointer;
    background: var(--brand); color: #fff; font-size: 28px; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 10px 26px rgba(0,0,0,.25);
  }

  /* Overlay y contenedor */
  #chatOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; z-index: 2147483647;
  }
  #chatContainer {
    position: absolute; bottom: 24px; right: 24px;
    width: min(90vw, 380px); height: min(78vh, 560px);
    background: var(--bg); color: var(--text);
    border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.35);
    display: flex; flex-direction: column; overflow: hidden;
  }

  /* Header */
  .chat-header {
    display: flex; align-items: center; gap: 10px; padding: 12px 14px;
    background: #121212; color: #fff;
  }
  .chat-header .avatar {
    width: 36px; height: 36px; border-radius: 50%; border: 2px solid #121212; object-fit: cover;
  }
  .chat-header .title { line-height: 1.1; font-weight: 700; }
  .chat-header .status { font-size: 12px; color: #c5f1ff; }

  .header-actions { margin-left: auto; display: flex; gap: 8px; }
  .icon-btn {
    width: 32px; height: 32px; border: 0; border-radius: 8px; cursor: pointer;
    display: grid; place-items: center; background: rgba(255,255,255,.08); color: #fff;
  }

  /* Mensajes */
  #messages {
    flex: 1; padding: 12px; overflow-y: auto; background: #fff;
    display: flex; flex-direction: column; gap: 8px;
  }
  .msg {
    max-width: 80%; padding: 10px 12px; border-radius: 14px; font-size: 14px; line-height: 1.35;
    word-wrap: break-word; white-space: pre-wrap;
  }
  .msg.bot { background: var(--bot); align-self: flex-start; }
  .msg.user { background: var(--user); color: #fff; align-self: flex-end; }
  .msg .buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
  .msg .buttons button {
    border: 1px solid #cfd8e3; background: #fff; color: #0f172a; padding: 6px 10px; border-radius: 10px; cursor: pointer; font-size: 13px;
  }

  /* Input */
  .input-row {
    display: flex; gap: 8px; padding: 10px; border-top: 1px solid #e5e7eb; background: #fff;
  }
  #userInput {
    flex: 1; resize: none; min-height: 42px; max-height: 140px; padding: 10px 12px;
    border: 1px solid #d1d5db; border-radius: 12px; font-size: 14px; outline: none;
  }
  #sendBtn {
    border: 0; background: var(--brand); color: #fff; padding: 0 16px; border-radius: 12px; cursor: pointer; font-weight: 600;
  }
  #sendBtn[disabled] { opacity: .6; cursor: not-allowed; }

  /* Typing dots */
  .typing {
    display: inline-flex; gap: 4px; align-items: center;
  }
  .typing .dot {
    width: 6px; height: 6px; border-radius: 50%; background: #94a3b8; animation: blink 1s infinite ease-in-out;
  }
  .typing .dot:nth-child(2) { animation-delay: .15s; }
  .typing .dot:nth-child(3) { animation-delay: .3s; }
  @keyframes blink { 0%, 80%, 100% { opacity: .2 } 40% { opacity: 1 } }

  /* Modo oscuro opcional con prefers-color-scheme */
  @media (prefers-color-scheme: dark) {
    :root { --bg: #0b0d10; --text: #e5e7eb; --bot: #12161c; }
    #messages { background: #0b0d10; }
    .msg.user { color: #eaf6ff; }
    .msg .buttons button { background: #0b0d10; color: #e5e7eb; border-color: #2b3441; }
    #userInput { background: #0b0d10; color: #e5e7eb; border-color: #2b3441; }
    .input-row { background: #0b0d10; border-top-color: #2b3441; }
  }
</style>
</head>
<body>

<!-- Bot√≥n flotante -->
<button id="chatbotBtn" aria-label="Abrir chat">üí¨</button>

<!-- Overlay y ventana -->
<div id="chatOverlay" role="dialog" aria-modal="true" aria-label="Chat">
  <div id="chatContainer">
    <div class="chat-header">
      <img class="avatar" src="https://storage.googleapis.com/databot-official-migrated/dashboard_api/d06c75bf-d5c6-4413-8fd5-750a209830ae_842fb154-2be8-4b9a-993f-e9f3ebec5c05.png" alt="Bot" />
      <div>
        <div class="title">Asistente IA</div>
        <div class="status">Disponible ahora</div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="restartBtn" title="Reiniciar">‚ü≤</button>
        <button class="icon-btn" id="closeBtn" title="Cerrar">‚úï</button>
      </div>
    </div>

    <div id="messages"></div>

    <div class="input-row">
      <textarea id="userInput" placeholder="Escribe aqu√≠ tu mensaje..." rows="1" maxlength="1000"></textarea>
      <button id="sendBtn">Enviar</button>
    </div>
  </div>
</div>

<script>
  // 1) PON TU WEBHOOK AQU√ç
  // Ejemplo: const WEBHOOK_URL = "https://n8n.tu-dominio.cl/webhook/chat-ui";
  const WEBHOOK_URL = "https://n8n.iie.cl/webhook/chat-ui"; // <- c√°mbialo

  // 2) Opcional: encabezados extra o auth simple (por ejemplo un token de n8n)
  const EXTRA_HEADERS = {
    // "Authorization": "Bearer TU_TOKEN_SI_APLICA"
  };

  // Utilidades
  const $ = (sel) => document.querySelector(sel);

  const btnOpen = $("#chatbotBtn");
  const overlay = $("#chatOverlay");
  const btnClose = $("#closeBtn");
  const btnRestart = $("#restartBtn");
  const messages = $("#messages");
  const input = $("#userInput");
  const sendBtn = $("#sendBtn");

  // Mantener sesi√≥n/conversaci√≥n
  const SESSION_KEY = "chat_widget_session_id_v1";
  const sessionId = getOrCreateSessionId();
  let lastPayload = null; // para botones

  // Eventos
  btnOpen.addEventListener("click", () => {
    overlay.style.display = "block";
    input.focus();
    if (!messages.dataset.booted) {
      bootGreeting();
      messages.dataset.booted = "1";
    }
  });
  btnClose.addEventListener("click", () => overlay.style.display = "none");
  btnRestart.addEventListener("click", () => {
    messages.innerHTML = "";
    lastPayload = null;
    bootGreeting();
  });

  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Mensaje inicial local
  function bootGreeting() {
    addBotMessage("¬°Hola! Soy tu asistente. ¬øEn qu√© te ayudo hoy?");
  }

  // Render de mensajes
  function addUserMessage(text) {
    addMessage(text, "user");
  }
  function addBotMessage(text, buttons = []) {
    addMessage(text, "bot", buttons);
  }
  function addTyping() {
    const wrap = document.createElement("div");
    wrap.className = "msg bot";
    wrap.id = "typingRow";
    wrap.innerHTML = `
      <span class="typing">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </span>
    `;
    messages.appendChild(wrap);
    messages.scrollTop = messages.scrollHeight;
  }
  function removeTyping() {
    const t = $("#typingRow");
    if (t) t.remove();
  }

  function addMessage(text, who, buttons = []) {
    const row = document.createElement("div");
    row.className = `msg ${who}`;
    const safe = typeof text === "string" ? text : JSON.stringify(text, null, 2);
    row.textContent = safe;

    if (who === "bot" && Array.isArray(buttons) && buttons.length) {
      const box = document.createElement("div");
      box.className = "buttons";
      buttons.forEach(b => {
        const btn = document.createElement("button");
        btn.textContent = b.label || "Opci√≥n";
        btn.addEventListener("click", () => {
          lastPayload = b.payload ?? null;
          addUserMessage(btn.textContent);
          sendToWebhook({ message: btn.textContent, payload: lastPayload });
        });
        box.appendChild(btn);
      });
      row.appendChild(box);
    }

    messages.appendChild(row);
    messages.scrollTop = messages.scrollHeight;
  }

  // Env√≠o de mensaje
  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    addUserMessage(text);
    input.value = "";
    sendToWebhook({ message: text, payload: lastPayload });
  }

  // POST al webhook
  async function sendToWebhook({ message, payload }) {
    addTyping();
    setInputEnabled(false);
    try {
      const body = {
        sessionId,
        message,
        payload: payload ?? null,
        source: "web-widget",
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent
      };

      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...EXTRA_HEADERS
        },
        body: JSON.stringify(body),
      });

      const isJson = res.headers.get("content-type")?.includes("application/json");
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = isJson ? await res.json() : { text: await res.text() };

      // Formatos soportados:
      // { text: "..." }
      // { text: "...", buttons: [{label, payload}, ...] }
      // O un string simple
      const botText = typeof data === "string" ? data : (data.text ?? "[Sin texto]");
      const botButtons = Array.isArray(data.buttons) ? data.buttons : [];
      addBotMessage(botText, botButtons);

      // Si el backend devuelve nextPayload o reinicia la memoria
      lastPayload = data.nextPayload ?? lastPayload;
      if (data.reset === true) lastPayload = null;

    } catch (err) {
      addBotMessage("Hubo un problema al contactar el servidor. Intenta de nuevo.");
      console.error(err);
    } finally {
      removeTyping();
      setInputEnabled(true);
      input.focus();
    }
  }

  function setInputEnabled(enabled) {
    input.disabled = !enabled;
    sendBtn.disabled = !enabled;
  }

  function getOrCreateSessionId() {
    const existing = localStorage.getItem(SESSION_KEY);
    if (existing) return existing;
    const sid = cryptoRandomId();
    localStorage.setItem(SESSION_KEY, sid);
    return sid;
  }

  // ID aleatorio simple
  function cryptoRandomId(len = 24) {
    if (window.crypto && crypto.getRandomValues) {
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return Array.from(arr, b => b.toString(16).padStart(2, "0")).join("");
    }
    return Math.random().toString(36).slice(2) + Date.now().toString(36);
  }
</script>
</body>
</html>
