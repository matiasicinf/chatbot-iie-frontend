<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Chatbot IIE Personalizado</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --chat--color--primary: #006D9C;
      --chat--color--primary-hover: #005580;
      --chat--color--secondary: #A1D5EB;
      --chat--color-secondary-shade-50: #F1F5F9;
      --chat--color-light: #FFFFFF;
      --chat--color--primary-shade-50: #2299C5;
      --chat--color--primary--shade-100: #2299C5;
      --chat--color-white: #FFFFFF;
      --chat--color-dark: #1E293B;
      --chat--color-disabled: #94A3B8;
      --chat--color-typing: #64748B;
      --chat--border-radius: 1rem;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body,
    input,
    button {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
      margin: 0;
      padding: 0;
    }

    /* ======== BOT√ìN FLOTANTE ======== */
    #chat-toggle {
      position: fixed;
      bottom: 25px;
      right: 25px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #006D9C 0%, #009FD6 100%);
      color: white;
      font-size: 28px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: var(--shadow-xl);
      z-index: 9999;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 3px solid rgba(255, 255, 255, 0.2);
    }

    #chat-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 25px 50px -12px rgba(0, 109, 156, 0.5);
    }

    /* ======== CONTENEDOR CHAT ======== */
    #custom-chat-widget {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: var(--chat--color-light);
      border-radius: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 9998;
    }

    /* ======== HEADER MODERNO ======== */
    #chat-header {
      background: linear-gradient(135deg, #006D9C 0%, #009FD6 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      /* Reduce el padding para hacerlo m√°s compacto */
      height: auto;
      /* Elimina la altura fija para permitir adaptaci√≥n */
      min-height: 50px;
      /* Ajusta el valor de la altura m√≠nima */
      box-shadow: 0 4px 12px rgba(0, 109, 156, 0.15);
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    #chat-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
      pointer-events: none;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 1;
      flex-shrink: 0;
    }

    .chat-logo {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      padding: 0;
      object-fit: cover;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      cursor: pointer;
      flex-shrink: 0;
    }

    .chat-logo:hover {
      transform: scale(1.15);
    }

    .chat-title-box {
      display: flex;
      flex-direction: column;
      line-height: 1.3;
    }

    .chat-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin: 0;
      letter-spacing: -0.01em;
    }

    .chat-subtitle {
      font-size: 0.75rem;
      margin: 0;
      color: rgba(255, 255, 255, 0.85);
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #22C55E;
      border-radius: 50%;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.6;
      }
    }

    .chat-header-right {
      display: flex;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .chat-header-right img {
      cursor: pointer;
      filter: brightness(0) invert(1);
      transition: all 0.3s ease;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.15);
      opacity: 0.95;
      width: 34px;
      /* Ajusta el tama√±o deseado */
      height: 34px;
      /* Ajusta el tama√±o deseado */
    }

    .chat-header-right img:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
      opacity: 1;
    }

    /* ======== MENSAJES ======== */
    #messages-container {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      background: linear-gradient(to bottom, #F8FAFC 0%, #F1F5F9 100%);
      scroll-behavior: smooth;
    }

    #messages-container::-webkit-scrollbar {
      width: 6px;
    }

    #messages-container::-webkit-scrollbar-track {
      background: transparent;
    }

    #messages-container::-webkit-scrollbar-thumb {
      background: #CBD5E1;
      border-radius: 3px;
    }

    #messages-container::-webkit-scrollbar-thumb:hover {
      background: #94A3B8;
    }

    .message {
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 85%;
      width: fit-content;
      word-wrap: break-word;
      animation: slideIn 0.3s ease-out;
      box-shadow: var(--shadow-sm);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Estilo para los enlaces generados por markdown */
    .bot-message a.chat-link {
      color: #1a0dab !important;
      /* Asegura que todos los enlaces tengan el mismo color */
      font-weight: normal !important;
      /* Elimina la negrita */
      /*text-decoration: none;  /* Elimina el subrayado de los enlaces */
      border-bottom: 1px solid #1a0dab;
      /* L√≠nea azul debajo del enlace */
    }

    /* Cambiar el color al pasar el mouse (hover) */
    .bot-message a.chat-link:hover {
      color: #1a0dab;
      /* Mantener el mismo color al hacer hover */
      border-bottom: 1px solid #1a0dab;
      /* Mantener la misma l√≠nea de color azul al pasar el mouse */
    }


    .message p {
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }

    .user-message {
      background: linear-gradient(135deg, #006D9C 0%, #0080B3 100%);
      color: white;
      margin-left: auto;
      text-align: right;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 109, 156, 0.2);
    }

    .bot-message {
      background: white;
      color: var(--chat--color-dark);
      margin-right: auto;
      text-align: left;
      border-bottom-left-radius: 4px;
      border: 1px solid #E2E8F0;
    }

    .bot-options-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      margin-top: 8px;
    }

    .message.bot-message {
      width: calc(100% - 20px);
      margin: 0 0 16px 10px;
      padding: 14px 16px;
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      box-sizing: border-box;
    }

    .chat-option-btn.list-item-btn {
      width: 100%;
      box-sizing: border-box;
      text-align: left;
      border-radius: 12px;
      border: 1.5px solid #E2E8F0;
      background: white;
      color: var(--chat--color-dark);
      padding: 14px 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 2px;
      box-shadow: var(--shadow-sm);
    }

    .chat-option-btn.list-item-btn:hover {
      background: #F8FAFC;
      border-color: var(--chat--color--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .chat-option-btn.list-item-btn:active {
      transform: translateY(0);
    }

    .chat-option-btn.list-item-btn a {
      display: flex;
      align-items: center;
      text-decoration: none;
      /* Elimina la l√≠nea debajo del √≠cono */
    }

    .chat-option-btn.list-item-btn img {
      vertical-align: middle;
      /* Alinea el √≠cono de WhatsApp con el texto */
      width: 18px;
      /* Ajusta el tama√±o del √≠cono */
      height: 18px;
      /* Ajusta el tama√±o del √≠cono */
    }

    /* ======== √ÅREA DE INPUT ======== */
    #input-area {
      display: flex;
      padding: 10px 20px;
      border-top: 1px solid #E2E8F0;
      background: white;
      gap: 12px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }

    #user-input {
      flex-grow: 1;
      padding: 12px 16px;
      border: 1.5px solid #E2E8F0;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: #F8FAFC;
    }

    #user-input:focus {
      outline: none;
      border-color: var(--chat--color--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(0, 109, 156, 0.1);
    }

    #send-button {
      background: linear-gradient(135deg, #006D9C 0%, #009FD6 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 8px 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-md);
      font-size: 12px;
    }

    #send-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    #send-button:active {
      transform: translateY(0);
    }

    /* ======== ENLACES ======== */
    .bot-message a.chat-link {
      color: var(--chat--color--primary);
      font-weight: 600;
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s ease;
    }

    .bot-message a.chat-link:hover {
      border-bottom-color: var(--chat--color--primary);
    }

    /* ======== LISTAS ======== */
    .bot-message ul,
    .bot-message ol {
      margin: 0.5em 0 0.5em 1.5em;
      padding: 0;
    }

    .bot-message li {
      margin-bottom: 0.4em;
      line-height: 1.5;
    }

    /* ======== INDICADOR DE ESCRITURA ======== */
    .typing-message {
      background: white;
      color: var(--chat--color-typing);
      margin-right: auto;
      text-align: left;
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      padding: 12px 16px;
      max-width: 80%;
      width: fit-content;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
      border: 1px solid #E2E8F0;
    }

    .typing-dots {
      display: inline-flex;
      gap: 4px;
    }

    .typing-dots span {
      display: inline-block;
      width: 7px;
      height: 7px;
      background: var(--chat--color--primary);
      border-radius: 50%;
      opacity: 0.4;
      animation: typing-blink 1.2s infinite;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing-blink {

      0%,
      80%,
      100% {
        opacity: 0.2;
        transform: scale(0.8);
      }

      40% {
        opacity: 1;
        transform: scale(1.1);
      }
    }

    /* ======== FORMULARIO ======== */
    #contact-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
      transition: opacity 0.6s ease;
    }

    #contact-form input,
    #contact-form textarea {
      padding: 12px 16px;
      border-radius: 10px;
      border: 1.5px solid #E2E8F0;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s ease;
      background: #F8FAFC;
    }

    #contact-form input:focus,
    #contact-form textarea:focus {
      outline: none;
      border-color: var(--chat--color--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(0, 109, 156, 0.1);
    }

    #contact-form textarea {
      min-height: 100px;
      resize: vertical;
    }

    #contact-form button[type="submit"] {
      background: linear-gradient(135deg, #006D9C 0%, #009FD6 100%);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      box-shadow: var(--shadow-md);
    }

    #contact-form button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .form-title {
      font-weight: 700;
      font-size: 1.25em;
      color: var(--chat--color-dark);
      margin-bottom: 8px;
      font-family: inherit;
    }

    @media (max-width: 600px) {
      #chat-header {
        padding: 8px 12px;
        /* Menos padding para pantallas m√°s peque√±as */
        min-height: 40px;
        /* Ajusta la altura m√≠nima */
      }

      .chat-logo {
        width: 32px;
        /* Reduzco el tama√±o del logo */
        height: 32px;
      }

      .chat-title {
        font-size: 0.9rem;
        /* Ajusto el tama√±o del texto */
      }

      .chat-subtitle {
        font-size: 0.7rem;
        /* Ajusto el tama√±o del texto */
      }
    }
  </style>
</head>

<body>
  <div id="custom-chat-widget">
    <div id="chat-header">
      <div class="chat-header-left">
        <img src="https://i.ibb.co/Cpg533kX/Asitente-Virtual.png" alt="Operadora IIE" class="chat-logo"
          loading="lazy" />
        <div class="chat-title-box">
          <h3 class="chat-title">Asistente Virtual</h3>
          <p class="chat-subtitle">
            <span class="status-dot"></span>
            En L√≠nea
          </p>
        </div>
      </div>

      <div class="chat-header-right">
        <img src="https://unpkg.com/lucide-static@latest/icons/refresh-cw.svg" id="restart-chat" alt="Reiniciar"
          title="Reiniciar conversaci√≥n" />
        <img src="https://unpkg.com/lucide-static@latest/icons/x.svg" id="minimize-chat" alt="Cerrar"
          title="Cerrar ventana" />
      </div>
    </div>

    <div id="messages-container"></div>

    <div id="input-area">
      <input type="text" id="user-input" placeholder="Escribe tu consulta..." />
      <button id="send-button">Enviar</button>
    </div>
  </div>

  <script>
    // =========================================================
    // 0) VARIABLES OCULTAS ‚Äî Se crean al cargar la p√°gina
    // =========================================================
    if (!sessionStorage.getItem('chat_categoria')) {
      sessionStorage.setItem('chat_categoria', null);
      sessionStorage.setItem('chat_subcategoria', null);
      sessionStorage.setItem('chat_titulo', null);
      sessionStorage.setItem('chat_pregunta', null);
    }

    // =========================================================
    // 1) FUNCIONES PARA GUARDAR VARIABLES OCULTAS
    // =========================================================
    function setCategoria(valor) {
      sessionStorage.setItem('chat_categoria', valor);
    }

    function setSubcategoria(valor) {
      sessionStorage.setItem('chat_subcategoria', valor);
    }

    function setTitulo(valor) {
      sessionStorage.setItem('chat_titulo', valor);
    }

    function setPregunta(valor) {
      sessionStorage.setItem('chat_pregunta', valor);
    }
    function setAula(valor) {
      sessionStorage.setItem('chat_aula', valor);
    }

    function resetVariablesOcultas() {
      sessionStorage.setItem('chat_categoria', null);
      sessionStorage.setItem('chat_subcategoria', null);
      sessionStorage.setItem('chat_titulo', null);
      sessionStorage.setItem('chat_pregunta', null);
      sessionStorage.setItem('chat_aula', null);
    }

    // =========================================================
    // 2) ACTUALIZADOR AUTOM√ÅTICO SEG√öN PAYLOAD
    // =========================================================
    function actualizarVariablesAutomaticas(message) {

      if (message.startsWith("CAT_")) {
        setCategoria(message.replace("CAT_", "").trim());
        return;
      }

      if (message.startsWith("SUBCAT_")) {
        setSubcategoria(message.replace("SUBCAT_", "").trim());
        return;
      }

      if (message.startsWith("TIT_")) {
        setTitulo(message.replace("TIT_", "").trim());
        return;
      }

      if (message.startsWith("PRE_")) {
        setPregunta(message.replace("PRE_", "").trim());
        return;
      }
      if (message.startsWith("AUL_")) {
        setAula(message.replace("AUL_", "").trim());
        return;
      }


      // Texto libre = se guarda como pregunta
      setPregunta(message);
    }



    // Obtener los par√°metros de la URL
    const params = new URLSearchParams(location.search);
    const selectedWebhook = params.get('webhook') || 'default';
    const nombreCursoParam = params.get('nombre_curso') || 'Nombre del curso no especificado';
    const correoCursoParam = params.get('correo_curso') || 'Correo no especificado';

    const WEBHOOKS = {
      default: 'https://n8n.iie.cl/webhook/genero',
      curso1: 'https://n8n.iie.cl/webhook/ciberacoso',
      curso2: 'https://n8n.iie.cl/webhook/ciudadania-digital',
      curso3: 'https://n8n.iie.cl/webhook/disena-tu-clase',
      curso4: 'https://n8n.iie.cl/webhook/tecnologias-digitales',
      curso5: 'https://n8n.iie.cl/webhook/tecnicas-de-aprendizaje-activo',
      curso6: 'https://n8n.iie.cl/webhook/aprendizaje-basado-en-proyectos',
      curso7: 'https://n8n.iie.cl/webhook/ciencias-naturales-con-tic',
      curso8: 'https://n8n.iie.cl/webhook/artes-con-tic',
      curso9: 'https://n8n.iie.cl/webhook/lenguaje-con-tic',
      curso10: 'https://n8n.iie.cl/webhook/evaluacion-y-retroalimentacion-de-aprendizajes',
      curso11: 'https://n8n.iie.cl/webhook/diseno-de-presentaciones',
      curso12: 'https://n8n.iie.cl/webhook/programacion-y-pensamiento-computacional-iii-iv',
      curso13: 'https://n8n.iie.cl/webhook/bases-curriculares-lengua-y-cultura-mapuche',
      curso14: 'https://n8n.iie.cl/webhook/genero',
    };

    const WEBHOOK_URL = WEBHOOKS[selectedWebhook] || WEBHOOKS.default;
    console.log('[Chat IIE] Usando webhook:', WEBHOOK_URL);

    const messagesContainer = document.getElementById('messages-container');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const chatWidget = document.getElementById('custom-chat-widget');
    const chatToggle = document.getElementById('chat-toggle');
    const minimizeBtn = document.getElementById('minimize-chat');
    const restartBtn = document.getElementById('restart-chat');
    const inIframe = (window.self !== window.top);
    const hideBtn = params.get('hideBtn') === '1' || inIframe;

    function openChat() {
      if (chatWidget) chatWidget.style.display = 'flex';
      if (chatToggle) chatToggle.style.display = 'none';
    }
    function closeChat() {
      if (chatWidget) chatWidget.style.display = 'none';
      if (chatToggle) chatToggle.style.display = 'flex';
    }

    if (chatToggle) chatToggle.addEventListener('click', openChat);
    if (minimizeBtn) {
      minimizeBtn.addEventListener('click', () => {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage('closeChat', '*');
        }
      });
    }

    if (hideBtn) {
      if (chatToggle) chatToggle.style.display = 'none';
      openChat();
    }

    if (restartBtn) {
      restartBtn.addEventListener('click', () => {
        resetVariablesOcultas();
        messagesContainer.innerHTML = '';
        initialMessage();
      });
    }

    let sessionId = localStorage.getItem('chatSessionId');
    if (!sessionId) {
      sessionId = 'session_' + Math.random().toString(36).substring(2, 9);
      localStorage.setItem('chatSessionId', sessionId);
    }

    let typingEl = null;

    function showTyping() {
      if (typingEl) return;
      typingEl = document.createElement('div');
      typingEl.className = 'message bot-message typing-message';
      typingEl.innerHTML = `
      <span>Escribiendo</span>
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
    `;
      messagesContainer.appendChild(typingEl);

      requestAnimationFrame(() => {
        const allMessages = messagesContainer.querySelectorAll('.message');
        const penultimateMessage = allMessages[allMessages.length - 2];
        if (penultimateMessage) {
          penultimateMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    function hideTyping() {
      if (!typingEl) return;
      typingEl.remove();
      typingEl = null;
    }

    async function sendMessage(message, isButtonPayload = false, buttonLabel = null) {
      if (verificarAccionEspecial(message)) return;
      actualizarVariablesAutomaticas(message);

      if (message !== '_INICIO') {
        if (isButtonPayload && buttonLabel) {

          const htmlLabel = marked.parseInline(buttonLabel);
          appendMessage(htmlLabel, 'user');
        } else {
          appendMessage(message, 'user');
        }
      }

      userInput.value = '';

      try {
        showTyping();

        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chatInput: message,
            sessionId: sessionId,

            // Variables invisibles
            categoria: sessionStorage.getItem('chat_categoria'),
            subcategoria: sessionStorage.getItem('chat_subcategoria'),
            titulo: sessionStorage.getItem('chat_titulo'),
            pregunta: sessionStorage.getItem('chat_pregunta'),
            aula: sessionStorage.getItem('chat_aula')
          })
        });

        const data = await response.json();

        hideTyping();
        renderResponse(data);
      } catch {
        // hideTyping();
        //  appendMessage("Lo siento, hubo un error de conexi√≥n.", 'bot');
      }
    }


    function renderResponse(data) {
      if (data.ignore) return;

      let text = data.text || "...";


      marked.setOptions({
        breaks: true,
        gfm: true
      });


      let html = marked.parse(text);

      // ******* 1. EVITAR V√çNCULOS EN CORREOS ELECTR√ìNICOS (L√≥gica existente) *******
      html = html.replace(
        /(\+56\s?9[\s-]?\d{4}[\s-]?\d{4})/g,  // Modificado para que capture el +56 con el n√∫mero
        function (match) {
          // 1. Elimina todos los caracteres no num√©ricos del n√∫mero capturado, pero mantenemos el +56
          let phoneNumber = match.replace(/\D/g, "");  // Elimina todos los caracteres no num√©ricos

          // 2. Aseguramos que el n√∫mero empieza con 56 y lo mantiene
          if (phoneNumber.startsWith("56")) {
            // No se necesita a√±adir nada si ya tiene el 56
          } else {
            // Si el n√∫mero comienza con +569 o con solo 9, lo corregimos a 56
            phoneNumber = "56" + phoneNumber.slice(1);
          }

          // 3. Crea la URL usando el n√∫mero de 11 d√≠gitos limpio (569XXXXXXXX)
          const waUrl = `https://wa.me/${phoneNumber}`;  // Ahora est√° correcto

          // 4. Devuelve el enlace con el n√∫mero completo como texto
          return `<a href="${waUrl}" class="chat-link" target="_blank">${match}</a>`;  // Hace que todo el n√∫mero sea un enlace
        }
      );

      // ******* 2. URLS GENERALES *******
      // Ahora las URLs se redirigen correctamente
      html = html.replace(
        /(?<!href=")(https?:\/\/[^\s<]+)/g,
        '<a href="$1" target="_blank" class="chat-link">$1</a>' // Para las URLs tambi√©n
      );
      html = html.replace(
        /(\+?\d{1,3}[\s-]?\(?\d+\)?[\s-]?\d{3,4}[\s-]?\d{3,4})/g,  // Para n√∫meros fijos
        function (match) {
          let phoneNumber = match.replace(/\D/g, "");  // Elimina caracteres no num√©ricos

          // Si no es m√≥vil (no empieza con 9, +569 o 56), lo tratamos como un n√∫mero fijo
          if (!phoneNumber.startsWith("56") && !phoneNumber.startsWith("9") && !phoneNumber.startsWith("+569")) {
            const telUrl = `tel:${phoneNumber}`;  // Enlace de llamada
            return `<a href="${telUrl}" class="chat-link chat-link-standard">${match}</a>`;  // Mostrar enlace de llamada
          }

          // Si es un n√∫mero m√≥vil, lo dejamos sin cambios
          return match;
        }
      );

      appendMessage(html, 'bot', false);
      const showDefaultButtons = data.showDefaultButtons === true || data.text?.includes('SHOW_DEFAULT_BUTTONS');

      if (showDefaultButtons) {
        // Mostrar los botones predefinidos del frontend
        mostrarBotonesDefault();
      } else if (data.extra || (data.buttons && data.buttons.length)) {
        // Mostrar botones personalizados del backend
        const blockDiv = document.createElement('div');
        blockDiv.className = 'message bot-message';

        if (data.extra) {
          const p = document.createElement('p');
          p.innerHTML = marked.parse(data.extra);
          blockDiv.appendChild(p);

          const hr = document.createElement('hr');
          hr.style.border = "1px solid #E2E8F0";
          hr.style.margin = "8px 0";
          blockDiv.appendChild(hr);
        }

        if (data.buttons && Array.isArray(data.buttons)) {
          const buttonsContainer = document.createElement('div');
          buttonsContainer.className = 'bot-options-list';

          data.buttons.forEach(button => {
            let btn;
            if (button.url) {
              btn = document.createElement('a');
              btn.href = button.url;
              btn.target = '_blank';
            } else {
              btn = document.createElement('button');
              btn.onclick = () => {
                btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                sendMessage(button.payload, true, button.label);
              };
            }

            btn.className = 'chat-option-btn list-item-btn';
            btn.innerHTML = marked.parseInline(button.label);
            buttonsContainer.appendChild(btn);
          });

          blockDiv.appendChild(buttonsContainer);
        }

        messagesContainer.appendChild(blockDiv);
      }

      // Scroll al √∫ltimo mensaje del usuario
      const allMessages = messagesContainer.querySelectorAll('.message');
      let lastUserMessage = null;

      for (let i = allMessages.length - 1; i >= 0; i--) {
        if (allMessages[i].classList.contains('user-message')) {
          lastUserMessage = allMessages[i];
          break;
        }
      }

      if (lastUserMessage) {
        requestAnimationFrame(() => {
          lastUserMessage.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
            inline: 'nearest'
          });
        });
      }
    }

    // üÜï NUEVA FUNCI√ìN: Mostrar botones predefinidos del frontend
    function mostrarBotonesDefault() {
      const blockDiv = document.createElement('div');
      blockDiv.className = 'message bot-message';

      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'bot-options-list';

      // Bot√≥n 1: Preguntas frecuentes
      const btn1 = document.createElement('button');
      btn1.className = 'chat-option-btn list-item-btn';
      btn1.innerHTML = 'üìö Ver preguntas frecuentes';
      btn1.onclick = () => sendMessage('ACTION_PREGUNTAS_FRECUENTES', true, 'üìö Ver preguntas frecuentes');
      buttonsContainer.appendChild(btn1);

      // Bot√≥n 2: WhatsApp
      const btn4 = document.createElement('a');
      btn4.className = 'chat-option-btn list-item-btn';
      btn4.innerHTML = `
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg"
      alt="WhatsApp"
      style="width:18px; height:18px; vertical-align:middle; margin-right:4px;">
    Chatear por WhatsApp`;
      btn4.onclick = (e) => {
        e.preventDefault();
        sendMessage("BTN_WSP", true, "Chatear por WhatsApp");
        setTimeout(() => {
          window.open("https://wa.me/56986851342", "_blank");
        }, 200);
      };
      btn4.style.textDecoration = 'none';
      buttonsContainer.appendChild(btn4);

      // Bot√≥n 3: Formulario de contacto
      const btn3 = document.createElement('button');
      btn3.className = 'chat-option-btn list-item-btn';
      btn3.innerHTML = '‚úâÔ∏è Env√≠anos tu consulta';
      btn3.onclick = () => {
        sendMessage('BTN_CORREO', true, '‚úâÔ∏è Env√≠anos tu consulta');
        setTimeout(() => { 
          //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  // 
          //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  // 
          //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  // 

           mostrarFormularioContacto();


          //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  //  // 
          // esto se cambio $OJOOOOOOOOOO$                    sendMessage('ENVIAR_CORREO', true, '‚úâÔ∏è Env√≠anos tu consulta');
        }, 200);
      };
      buttonsContainer.appendChild(btn3);

      blockDiv.appendChild(buttonsContainer);
      messagesContainer.appendChild(blockDiv);
    }


    async function mostrarFormularioContacto() {
      const blockDiv = document.createElement('div');
      blockDiv.className = 'message bot-message';

      blockDiv.innerHTML = `
      <p class="form-title">üìß Formulario de Contacto</p>
      <form id="contact-form">
        <input type="text" name="nombre" placeholder="Nombre completo" required>
        <input type="email" name="correo" placeholder="Correo electr√≥nico" required>
        <input type="text" name="telefono" placeholder="Tel√©fono (opcional)">
        <textarea name="mensaje" placeholder="Escribe tu mensaje aqu√≠..." required></textarea>
        <button type="submit">Enviar datos</button>
        <p id="sending-status" style="display:none; color:#006D9C; text-align:center; font-weight:500;">
          Enviando tus datos...
        </p>
      </form>
    `;

      messagesContainer.appendChild(blockDiv);
      blockDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

      const form = blockDiv.querySelector('#contact-form');
      const status = blockDiv.querySelector('#sending-status');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();  // Prevenir el comportamiento por defecto del formulario (recargar p√°gina)

        // Obtener los valores del formulario
        const nombre = form.querySelector('[name="nombre"]').value;
        const correo = form.querySelector('[name="correo"]').value;
        const telefono = form.querySelector('[name="telefono"]').value;
        const mensaje = form.querySelector('[name="mensaje"]').value;

        // Obtener las variables del curso y correo (le√≠das desde los params de la URL)
        console.log('Nombre del curso:', nombreCursoParam);
        console.log('Correo del curso:', correoCursoParam);

        // Crear el objeto con los datos que se enviar√°n
        const formData = {
          nombre,
          correo,
          telefono,
          mensaje,
          nombre_curso: nombreCursoParam, // Usar la variable le√≠da de la URL
          correo_curso: correoCursoParam  // Usar la variable le√≠da de la URL
        };

        // Deshabilitar todos los campos del formulario para prevenir env√≠os repetidos
        const inputs = form.querySelectorAll('input, textarea, button');
        inputs.forEach(el => el.disabled = true);

        // Mostrar el estado de env√≠o del formulario
        status.style.display = 'block';

        try {
          // Enviar los datos al servidor (n8n webhook)
          const response = await fetch("https://n8n.iie.cl/webhook/form-contacto", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          // Si la respuesta es exitosa, ocultamos el formulario y mostramos un mensaje de √©xito
          if (response.ok) {
            form.style.opacity = "0";
            setTimeout(() => form.style.display = "none", 600);  // Ocultar el formulario con animaci√≥n
            appendMessage("‚úÖ ¬°Gracias! Hemos recibido tu mensaje y te contactaremos pronto.", "bot");
          } else {
            // Si ocurre un error con la respuesta, mostrar mensaje de error
            appendMessage("‚ö†Ô∏è Ocurri√≥ un error al enviar el formulario. Intenta nuevamente m√°s tarde.", "bot");
            status.style.display = 'none';  // Ocultar el estado de env√≠o
            inputs.forEach(el => el.disabled = false);  // Habilitar los inputs nuevamente
          }
        } catch (error) {
          // Si hay un error de conexi√≥n o otro tipo, mostrar mensaje de error
          appendMessage("‚ö†Ô∏è Error de conexi√≥n. Revisa tu red e int√©ntalo otra vez.", "bot");
          status.style.display = 'none';  // Ocultar el estado de env√≠o
          inputs.forEach(el => el.disabled = false);  // Habilitar los inputs nuevamente
        }
      });

    }

    function verificarAccionEspecial(message) {
      if (message === 'ENVIAR_CORREO') {
        mostrarFormularioContacto();
        return true;
      }
      return false;
    }

    function appendMessage(message, sender, scroll = true) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${sender}-message`;
      const p = document.createElement('p');
      p.innerHTML = message;
      msgDiv.appendChild(p);
      messagesContainer.appendChild(msgDiv);

      // Eliminamos el desplazamiento autom√°tico
      // No se llama a la funci√≥n que hace scroll.
    }


    sendButton.addEventListener('click', () => {
      const input = userInput.value.trim();
      if (input) sendMessage(input);
    });

    userInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const input = userInput.value.trim();
        if (input) sendMessage(input);
      }
    });

    function initialMessage() {
      const blockDiv = document.createElement('div');
      blockDiv.className = 'message bot-message';

      const p = document.createElement('p');
      p.innerHTML = 'üëã ¬°Hola! Es un placer ayudarte. Soy tu Asistente Virtual y estoy aqu√≠ para guiarte. ¬øC√≥mo puedo asistirte hoy? Escribe tu pregunta o elige una opci√≥n:';
      p.style.marginBottom = '12px';
      blockDiv.appendChild(p);

      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'bot-options-list';

      const btn1 = document.createElement('button');
      btn1.className = 'chat-option-btn list-item-btn';
      btn1.innerHTML = 'üìö  Ver preguntas frecuentes';
      btn1.onclick = () => sendMessage('ACTION_PREGUNTAS_FRECUENTES', true, 'üìö Ver preguntas frecuentes');
      buttonsContainer.appendChild(btn1);

      const btn4 = document.createElement('a');
      btn4.className = 'chat-option-btn list-item-btn';
      btn4.innerHTML = `
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg"
          alt="WhatsApp"
          style="width:18px; height:18px; vertical-align:middle; margin-right:0px;">
        Chatear por WhatsApp`;
      //btn4.href = 'https://wa.me/56986851342';
      //btn4.target = '_blank';
      btn4.onclick = () => {
        // Solo enviamos m√©trica a n8n
        sendMessage("BTN_WSP", true, "Chatear por WhatsApp");

        // Abrimos el WhatsApp REAL
        setTimeout(() => {
          window.open("https://wa.me/56986851342", "_blank");
        }, 200);
      };
      btn4.style.textDecoration = 'none';  // Elimina el subrayado del enlace
      buttonsContainer.appendChild(btn4);

      const btn3 = document.createElement('button');
      btn3.className = 'chat-option-btn list-item-btn';
      btn3.innerHTML = '‚úâÔ∏è Env√≠anos tu consulta';
      btn3.onclick = () => {
        // 1) Enviar m√©trica al backend
        sendMessage('BTN_CORREO', true, '‚úâÔ∏è Env√≠anos tu consulta');

        // 2) Ejecutar la acci√≥n normal del bot√≥n
        setTimeout(() => {
          sendMessage('ENVIAR_CORREO', true, '‚úâÔ∏è Env√≠anos tu consulta');
        }, 200);
      };

      buttonsContainer.appendChild(btn3);

      blockDiv.appendChild(buttonsContainer);
      messagesContainer.appendChild(blockDiv);

      const allMessages = messagesContainer.querySelectorAll('.message');
      const penultimateMessage = allMessages[allMessages.length - 2];

      if (penultimateMessage) {
        penultimateMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    initialMessage();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>

</html>
